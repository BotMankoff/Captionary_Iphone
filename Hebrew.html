<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Captionary - גרסה עברית</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 8px;
      user-select: none;
      -webkit-user-select: none;
    }

    h1 {
      color: white;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 1.1em;
      text-align: center;
    }

    .game-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 5px;
      width: 100%;
      max-width: 400px;
      flex-grow: 1;
    }

    .cube-container { 
      perspective: 1000px; 
      width: 100%;
      max-width: 380px;
      height: 520px;
      position: relative;
      margin: 0 auto;
    }

    .cube {
      width: 100%; 
      height: 100%; 
      position: absolute;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      transform: translateZ(-260px);
    }

    .cube-face {
      position: absolute; 
      width: 100%;
      height: 520px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 6px;
      backface-visibility: hidden;
    }

    .cube-face.active {
      border: 3px solid gold;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    }

    .cube-face.front  { transform: rotateY(0deg) translateZ(230px); }
    .cube-face.back   { transform: rotateY(180deg) translateZ(230px); }
    .cube-face.right  { transform: rotateY(90deg) translateZ(230px); }
    .cube-face.left   { transform: rotateY(-90deg) translateZ(230px); }
    .cube-face.top    { transform: rotateX(90deg) translateZ(260px); }
    .cube-face.bottom { transform: rotateX(-90deg) translateZ(260px); }

    .face-content {
      width: 100%; 
      height: 100%;
      display: grid; 
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr 1fr;
      gap: 4px;
    }

    .cartoon-box {
      border: 2px solid #ddd;
      border-radius: 5px;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      padding: 3px;
    }

    .cartoon-box.correct {
      border-color: #4CAF50;
      background: #4CAF50;
    }
    
    .cartoon-box.correct .cartoon-image {
      background: white;
    }
    
    .cartoon-box.correct .cartoon-caption {
      background: #4CAF50;
      color: white;
      font-weight: bold;
    }

    .cartoon-image {
      height: 65%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: height 0.3s ease;
      margin-top: 5px;
    }
    
    .game-container.pre-game-mode .cartoon-image {
        height: 100%;
        margin-top: 0;
    }
    
    .game-container.pre-game-mode .cartoon-caption {
        height: 0;
        padding: 0;
        visibility: hidden;
    }

    .cartoon-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      background: white;
    }

    .cartoon-image.enlarged {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
      width: 65vw;
      max-width: 350px;
      height: 65vw;
      max-height: 250px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-radius: 10px;
      background: white !important;
      padding: 10px;
      opacity: 1;
    }

    .cartoon-image.enlarged img {
      opacity: 1;
      filter: none;
      background: white !important;
      filter: brightness(1) contrast(1);
    }
    
    .image-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: none;
      z-index: 999;
    }
    
    .image-backdrop.show {
      display: block;
    }

    .image-placeholder {
      text-align: center;
      color: #666;
      font-size: 9px;
      padding: 3px;
    }

    .cartoon-caption {
      height: 35%;
      padding: 2px 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 11px; /* Slightly larger for Hebrew script */
      font-weight: 500;
      line-height: 1.2;
      background: #f8f9fa;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      word-wrap: break-word;
      margin-bottom: 2px;
      transition: height 0.3s ease, padding 0.3s ease;
    }

    .cartoon-caption.selectable {
      cursor: pointer;
    }

    .cartoon-caption.selected {
      background: #2196F3;
      color: white;
      font-weight: bold;
    }

    .info-bar {
      background: white;
      border-radius: 10px;
      padding: 8px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .face-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .face-name {
      font-weight: bold;
      color: #764ba2;
      font-size: 12px;
    }

    .face-dots {
      display: flex;
      gap: 3px;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #ddd;
    }

    .dot.active {
      background: #764ba2;
    }

    .stats {
      display: flex;
      gap: 10px;
      font-size: 10px;
    }

    .stat-item {
      color: #666;
    }

    .stat-value {
      color: #2196F3;
      font-weight: bold;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .btn {
      padding: 7px 8px;
      border: none;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      color: white;
      transition: transform 0.1s;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn-start { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      grid-column: span 3;
    }
    .wobble-animation {
      animation: soft-shake 3s ease-in-out infinite;
    }

    .btn-rotate { background: #607d8b; }
    .btn-help-inline { background: #2196F3; }
    .btn-new { background: #9c27b0; }

    .win-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      transition: transform 0.3s;
    }

    .win-overlay.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .win-message {
      font-size: 20px;
      color: #4CAF50;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .help-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .help-modal.show {
      display: flex;
    }

    .help-content {
      background: white;
      border-radius: 15px;
      padding: 20px;
      max-width: 350px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .help-title {
      color: #764ba2;
      margin-bottom: 15px;
      font-size: 20px;
      text-align: center;
    }

    .help-section {
      margin-bottom: 15px;
    }
    
    .help-section p {
      font-size: 13px; /* Larger for Hebrew */
      line-height: 1.4;
      color: #333;
    }
    
    .help-section ul {
        list-style-position: inside;
        font-size: 13px; /* Larger for Hebrew */
        line-height: 1.4;
        color: #333;
    }

    .close-help {
      float: right;
      font-size: 24px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
    }

    .mode-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: bold;
      color: #764ba2;
      display: none;
      z-index: 10;
    }

    .cube-face.active .mode-badge {
      display: block;
    }

    @media (max-height: 700px) {
      .cube-container {
        height: 480px;
      }
      .cube-face {
        height: 480px;
      }
      h1 {
        font-size: 1.0em;
        margin-bottom: 3px;
      }
    }
    
    @keyframes soft-shake {
      0%, 100% { transform: rotate(0deg); }
      5% { transform: rotate(3deg); }
      10% { transform: rotate(-3deg); }
      15% { transform: rotate(3deg); }
      20% { transform: rotate(0deg); }
    }
    
    /* =================================================================== */
    /* START: RTL (RIGHT-TO-LEFT) SPECIFIC STYLES                        */
    /* =================================================================== */
    [dir="rtl"] .close-help {
      float: left;
    }
    [dir="rtl"] .mode-badge {
      right: auto;
      left: 5px;
    }
    [dir="rtl"] .help-section ul {
      padding-left: 0;
      padding-right: 5px;
    }
    /* =================================================================== */
    /* END: RTL STYLES                                                   */
    /* =================================================================== */
  </style>
</head>
<body>
  <h1>Captionary</h1>

<div class="help-modal" id="helpModal">
    <div class="help-content">
      <button class="close-help" onclick="toggleHelp()">×</button>
      <h2 class="help-title" id="helpTitle"></h2>
      <div class="help-section">
        <p id="helpGoal"></p>
        <p id="helpHowTo"></p>
        <p style="margin-top: 10px;" id="helpTipsTitle"></p>
        <ul>
            <li id="helpTip1"></li>
            <li id="helpTip2"></li>
            <li id="helpTip3"></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="game-container" id="gameContainer">
    <div class="cube-container">
      <div class="cube" id="cube">
        <div class="cube-face front" data-face="0">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="0"></div>
        </div>
        <div class="cube-face back" data-face="1">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="1"></div>
        </div>
        <div class="cube-face right" data-face="2">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="2"></div>
        </div>
        <div class="cube-face left" data-face="3">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="3"></div>
        </div>
        <div class="cube-face top" data-face="4">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="4"></div>
        </div>
        <div class="cube-face bottom" data-face="5">
          <div class="mode-badge" data-badge="playing"></div>
          <div class="face-content" data-face-content="5"></div>
        </div>
      </div>
    </div>

    <div class="info-bar">
      <div class="info-top">
        <div class="face-indicator">
          <div class="face-name" id="faceName"></div>
          <div class="face-dots">
            <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
        </div>
        <div class="stats">
          <span class="stat-item"><span data-label="time"></span>: <span class="stat-value" id="timer">0s</span></span>
          <span class="stat-item"><span data-label="swaps"></span>: <span class="stat-value" id="swaps">0</span></span>
        </div>
      </div>
      <div class="buttons">
        <button class="btn btn-start" onclick="togglePlay()" id="startBtn"></button>
        <button class="btn btn-rotate" onclick="rotateCube()" id="rotateBtn"></button>
        <button class="btn btn-help-inline" onclick="toggleHelp()" id="helpBtn"></button>
        <button class="btn btn-new" onclick="newGame()" id="newBtn"></button>
      </div>
    </div>
  </div>

  <div class="win-overlay" id="winOverlay">
    <div class="win-message" id="winMessage"></div>
    <div id="winStats"></div>
  </div>

  <script>
    // ===================================================================
    // START: HEBREW LANGUAGE DATA
    // ===================================================================
    const hebrewStrings = {
        startGame: "התחל משחק",
        stop: "עצור",
        rotate: "סובב",
        howToPlay: "הוראות",
        newGame: "חדש",
        time: "זמן",
        swaps: "החלפות",
        faceNames: ['קדימה', 'אחורה', 'ימין', 'שמאל', 'למעלה', 'למטה'],
        faceComplete: "!שלב הושלם 🎉",
        cubeComplete: "!הקוביה הושלמה 🎉",
        congratulations: "!כל הכבוד",
        playing: "במשחק",
        helpTitle: "הוראות המשחק",
        helpGoal: "מטרה: התאם לכל קריקטורה את הכיתוב הנכון שלה.",
        helpHowTo: "אופן ההחלפה: לחץ על כיתוב כדי לבחור אותו. לחץ על כיתוב שני כדי להחליף את מיקומם. התאמות נכונות יצבעו בירוק!",
        helpTipsTitle: "טיפים:",
        helpTip1: "לחץ על קריקטורה כדי להגדיל אותה.",
        helpTip2: "השתמש בכפתור 'סובב' כדי לעבור לצד אחר של הקוביה.",
        helpTip3: "כפתור 'חדש' מאתחל את כל המשחקים בכל הצדדים."
    };

    const captionDataHE = {
        "AB102185": [`"אקנה"`],
        "AB103161": [`"אתה חושב שתחזור מתישהו למרוצי סוסים?"`],
        "AM600005": [`"זה לא יקום מקביל. זו הפרת זכויות יוצרים."`],
        "AM600051": [`"יש לנו דרכים לגרום לך לדבר על שטויות."`],
        "AM600122": [`"תמיד אפשר לזהות את התיירים."`],
        "AM600159": [`"הנה הוא. המקצוען."`],
        "AM600168": [`"תאמינו או לא, יש אנשים שלא רוצים ילדים."`],
        "AM600260": [`"זו מיאמי, ניתן למפלס הים העולה לעשות את השאר."`],
        "AM600266": [`"אף אחד לא במצב רוח, גרג."`],
        "AM600267": [`"אני תמיד מחכה לסוף הקיץ כדי לבדוק אם הוא עדיין חי."`],
        "AM600271": [`"כבר אמרתי סליחה."`],
        "AM600281": [`"אומרים שלפחות 80% מאיתנו לובשים את המידה הלא נכונה."`],
        "AM600304": [`"ברצינות, זה לא מדאיג אותך בכלל?"`],
        "AM600401": [`"חשבתי שכבר הסכמנו על עיטורי זהב."`],
        "AM900007": [`"לא ידעתי שאתה נגד פרוות."`],
        "AM900035": [`"ניסית לכבות ולהדליק את עצמך מחדש?"`],
        "AM900125": [`"יום חמישי זה בסדר, או שאתה צריך את זה מוקדם יותר?"`],
        "AM900275": [`"אולי כדאי שנמשיך לעבוד מהבית."`],
        "AM900280": [`"אני לא זוכר של מי, אבל הוא הבן של מישהו."`],
        "AM900319": [`"ג'פרי בתהליך התפראות."`],
        "AM900428": [`"יש משהו שאתה צריך לדעת עליי."`],
        "AM900503": [`"תבטיח לי שתתרום את גופי לעוגת בננה."`],
        "AM900531": [`"אני רואה שמישהו כבר טיפל לך בחיי המין."`],
        "AM900551": [`"לא אכפת לי כמה הוא טוב. אף אחד לא יכול לעשות שורט על ג'פרי."`],
        "AM900597": [`"הלקוח שלי מוכן להתפשר. הרגל עדיין אצלך?"`],
        "AM900682": [`"תודה לך, איש-הניסוח-הקצת-יותר-נכון!!"`],
        "AM901057": [`"פשוט תרחיק אותו מהילד שלי, בסדר?"`],
        "AM901177": [`"אז חוץ מאופרה והתגנבויות, מה אתה עושה כדי להירגע?"`],
        "AM901306": [`"אנחנו נאחר."`],
        "CC10561": [`"בבקשה! שב!"`],
        "CC120132": [`"בוב גדל בטבע על ידי סלמונים."`],
        "CC120750": [`"אני רואה שהבאת את תרשימי העוגה."`],
        "CC121027": [`"מזל שיש לך - עוד סנטימטר שמאלה וזה היה הסוף שלך."`],
        "CC121493": [`"גילוח וצחצוח."`],
        "CC121509": [`"לא יודע. מה את רוצה לעשות?"`],
        "CC122117": [`"תהיה כן - כמה ספורט אתה עושה?"`],
        "CC122199": [`"אתה בטוח שזו הדרך הנכונה לגרוס מסמכים?"`],
        "CC122588": [`"אמא, את הסיבה שיש לי חפיר."`],
        "CC122743": [`"אמא רוצה שתדעי מאיפה האוכל שלך מגיע."`],
        "CC122897": [`"אני חושב שזה לא בסדר לצוד אותם בתוך בית תפילה."`],
        "CC123459": [`"מה את רוצה, דניס? אני לא קורא מחשבות."`],
        "CC123743": [`"אתה יודע למה עצרתי אותך?"`],
        "CC123844": [`"אני בשנת שבתון."`],
        "CC124100": [`"ואת בטוחה שאלו היו תאונות?"`],
        "CC124127": [`"אתה יודע להקשיב."`],
        "CC124174": [`"ויליאם חובב פליאונטולוגיה."`],
        "CC124224": [`"תצטרך לנסח את זה אחרת. אין להם מילה ל'תביא'."`],
        "CC125413": [`"אוי! איזה פחד החדרת בי."`],
        "CC128261": [`"טוב, זו הייתה מסיבת יום הולדת שהילדים לא ישכחו בקרוב."`],
        "CC129565": [`"אני מקווה שאתה אוהב מטאפורות מעולם הספורט."`],
        "CC131098": [`"היא הייתה אישה זקנה וחמודה שהילדים שלה אף פעם לא התקשרו."`],
        "CC132676": [`"וזה בן דוד שלי דייב, הוא אחראי על החוכמה המקובלת."`],
        "CC134663": [`"אז איך הגלילים החדשים האלה בעיניך?"`],
        "CC135871": [`"התחלנו עם החלפת מפרק ירך ומשם פשוט אלתרנו."`]
    };
    // ===================================================================
    // END: HEBREW LANGUAGE DATA
    // ===================================================================

    const allowedContestNumbers = Object.keys(captionDataHE);
    const cartoonMetadata = [];
    allowedContestNumbers.forEach((contestNum, index) => {
      cartoonMetadata.push({ 
        id: index + 1, 
        contestNumber: contestNum, 
        imageFile: `${contestNum}.jpg` 
      });
    });

    let currentFace = 0;
    let isPlaying = false;
    let puzzles = [];
    let selectedCaption = null;
    let swapCount = 0;
    let seconds = 0;
    let timerInterval = null;
    let recentlyUsedCartoons = [];
    let solvedFaces = new Set(); 

    const backdrop = document.createElement('div');
    backdrop.className = 'image-backdrop';
    document.body.appendChild(backdrop);

    function closeEnlargedImage() {
        const enlargedElement = document.querySelector('.cartoon-image.enlarged');
        if (enlargedElement) enlargedElement.remove();
        backdrop.classList.remove('show');
    }
    
    function handleImageClick(e) {
      e.stopPropagation();
      if (document.querySelector('.cartoon-image.enlarged')) return;
      const originalImageDiv = e.currentTarget;
      const clone = originalImageDiv.cloneNode(true);
      clone.classList.add('enlarged');
      clone.addEventListener('click', closeEnlargedImage);
      document.body.appendChild(clone);
      backdrop.classList.add('show');
    }
    
    backdrop.addEventListener('click', closeEnlargedImage);

    function shuffle(arr) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function derange(arr) {
      let result = shuffle([...arr]);
      while (result.some((item, index) => item === arr[index])) {
        result = shuffle([...arr]);
      }
      return result;
    }

    function generatePuzzle() {
      const availableCartoons = cartoonMetadata.filter(c => !recentlyUsedCartoons.includes(c.contestNumber));
      const cartoonsToUse = availableCartoons.length >= 8 ? availableCartoons : cartoonMetadata;
      const selected = shuffle(cartoonsToUse).slice(0, 8);
      
      selected.forEach(cartoon => {
        if (!recentlyUsedCartoons.includes(cartoon.contestNumber)) {
          recentlyUsedCartoons.push(cartoon.contestNumber);
        }
      });
      
      if (recentlyUsedCartoons.length > 48) {
        recentlyUsedCartoons.splice(0, recentlyUsedCartoons.length - 48);
      }
      
      const puzzle = selected.map(cartoon => ({
        id: cartoon.id,
        contestNumber: cartoon.contestNumber,
        imageFile: cartoon.imageFile,
        correctCaption: captionDataHE[cartoon.contestNumber][0],
        currentCaption: ""
      }));
      
      const correctCaptions = puzzle.map(p => p.correctCaption);
      const derangedCaptions = derange(correctCaptions);
      puzzle.forEach((p, i) => { p.currentCaption = derangedCaptions[i]; });
      
      return puzzle;
    }

    function renderFace(faceIndex) {
      const content = document.querySelector(`[data-face-content="${faceIndex}"]`);
      if (!content) return;
      
      content.innerHTML = '';
      const puzzle = puzzles[faceIndex];
      const isFaceSolved = solvedFaces.has(faceIndex);

      puzzle.forEach((item, index) => {
        const box = document.createElement('div');
        box.className = 'cartoon-box';
        
        const isBoxIndividuallyCorrect = isPlaying && item.currentCaption === item.correctCaption;

        if (isFaceSolved || isBoxIndividuallyCorrect) {
          box.classList.add('correct');
        }
        
        const imageDiv = document.createElement('div');
        imageDiv.className = 'cartoon-image';
        imageDiv.addEventListener('click', handleImageClick);
        
        const img = document.createElement('img');
        img.alt = `Cartoon image`;
        img.src = `./${item.imageFile}`;
        imageDiv.appendChild(img);
        
        const captionDiv = document.createElement('div');
        captionDiv.className = 'cartoon-caption';
        
        if (isPlaying && !isFaceSolved) {
            captionDiv.classList.add('selectable');
        }
        
        captionDiv.textContent = isFaceSolved ? item.correctCaption : item.currentCaption;
        captionDiv.setAttribute('data-face', faceIndex);
        captionDiv.setAttribute('data-index', index);
        captionDiv.addEventListener('click', handleCaptionClick);
        
        box.appendChild(imageDiv);
        box.appendChild(captionDiv);
        content.appendChild(box);
      });
    }

    function startGameForCurrentFace() {
        if (isPlaying || solvedFaces.has(currentFace)) return;

        isPlaying = true;
        document.getElementById('gameContainer').classList.remove('pre-game-mode');
        
        seconds = 0;
        swapCount = 0;
        document.getElementById('timer').textContent = '0s';
        document.getElementById('swaps').textContent = '0';
        
        timerInterval = setInterval(() => {
            seconds++;
            document.getElementById('timer').textContent = seconds + 's';
        }, 1000);
        
        document.getElementById('startBtn').textContent = hebrewStrings.stop;
        document.getElementById('startBtn').classList.remove('wobble-animation');
        
        document.querySelectorAll('.cube-face').forEach(f => f.classList.remove('active'));
        document.querySelector(`.cube-face[data-face="${currentFace}"]`).classList.add('active');

        renderFace(currentFace);
    }

    function handleCaptionClick(e) {
        if (!isPlaying && !solvedFaces.has(currentFace)) {
            startGameForCurrentFace();
        }

        if (!isPlaying || solvedFaces.has(currentFace)) return;
      
        const el = e.target;
        const face = parseInt(el.dataset.face);
        const index = parseInt(el.dataset.index);
      
        if (face !== currentFace) return;
      
        if (!selectedCaption) {
            selectedCaption = { el, face, index };
            el.classList.add('selected');
        } else if (selectedCaption.el === el) {
            el.classList.remove('selected');
            selectedCaption = null;
        } else {
            const puzzle = puzzles[currentFace];
            [puzzle[selectedCaption.index].currentCaption, puzzle[index].currentCaption] = 
            [puzzle[index].currentCaption, puzzle[selectedCaption.index].currentCaption];
            
            swapCount++;
            document.getElementById('swaps').textContent = swapCount;
            
            selectedCaption.el.classList.remove('selected');
            selectedCaption = null;
            
            renderFace(currentFace);
            checkWin();
        }
    }

    function rotateCube() {
      if (selectedCaption) {
        selectedCaption.el.classList.remove('selected');
        selectedCaption = null;
      }
      closeEnlargedImage();
      if (solvedFaces.size === 6) return;
      
      let nextFace = (currentFace + 1) % 6;
      let checkedCount = 0;
      while (solvedFaces.has(nextFace) && checkedCount < 6) {
        nextFace = (nextFace + 1) % 6;
        checkedCount++;
      }
      currentFace = nextFace;
      
      const cube = document.getElementById('cube');
      const rotations = [ [0, 0], [0, 180], [0, -90], [0, 90], [-90, 0], [90, 0] ];
      const [x, y] = rotations[currentFace];
      cube.style.transform = `translateZ(-260px) rotateX(${x}deg) rotateY(${y}deg)`;
      
      document.getElementById('faceName').textContent = hebrewStrings.faceNames[currentFace];
      document.querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === currentFace));
      
      clearInterval(timerInterval);
      isPlaying = false;
      document.getElementById('startBtn').textContent = hebrewStrings.startGame;
      document.getElementById('startBtn').classList.add('wobble-animation');
      document.getElementById('timer').textContent = '0s';
      document.getElementById('swaps').textContent = '0';
      document.getElementById('gameContainer').classList.add('pre-game-mode');
      document.querySelectorAll('.cube-face').forEach(f => f.classList.remove('active'));

      renderFace(currentFace);
    }
    
    function togglePlay() {
      if (isPlaying) {
        clearInterval(timerInterval);
        isPlaying = false;
        document.getElementById('startBtn').textContent = hebrewStrings.startGame;
        document.getElementById('startBtn').classList.add('wobble-animation');
        document.querySelectorAll('.cube-face').forEach(f => f.classList.remove('active'));
      } else {
        startGameForCurrentFace();
      }
    }

    function checkWin() {
      const puzzle = puzzles[currentFace];
      if (solvedFaces.has(currentFace) || !puzzle.every(p => p.currentCaption === p.correctCaption)) {
          return;
      }
      
      clearInterval(timerInterval);
      isPlaying = false;
      solvedFaces.add(currentFace);
      
      const winOverlay = document.getElementById('winOverlay');
      const winMessage = document.getElementById('winMessage');
      const winStats = document.getElementById('winStats');

      if (solvedFaces.size === 6) {
        winMessage.textContent = hebrewStrings.cubeComplete;
        winStats.textContent = hebrewStrings.congratulations;
        winOverlay.classList.add('show');
        setTimeout(() => winOverlay.classList.remove('show'), 4000);
      } else {
        winMessage.textContent = hebrewStrings.faceComplete;
        winStats.textContent = `${hebrewStrings.time}: ${seconds}s | ${hebrewStrings.swaps}: ${swapCount}`;
        winOverlay.classList.add('show');
        
        setTimeout(() => {
          winOverlay.classList.remove('show');
          rotateCube();
        }, 2500);
      }
    }

    function newGame() {
      if (timerInterval) clearInterval(timerInterval);
      isPlaying = false;
      
      puzzles = [];
      recentlyUsedCartoons = [];
      solvedFaces.clear();
      
      for (let i = 0; i < 6; i++) {
        puzzles.push(generatePuzzle());
      }
      
      currentFace = 0;
      const cube = document.getElementById('cube');
      cube.style.transform = `translateZ(-260px) rotateX(0deg) rotateY(0deg)`;
      
      document.querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === 0));
      document.getElementById('gameContainer').classList.add('pre-game-mode');
      document.querySelectorAll('.cube-face').forEach(f => f.classList.remove('active'));

      renderFace(currentFace);
      setUIText();
    }
    
    function setUIText() {
        document.getElementById('startBtn').textContent = hebrewStrings.startGame;
        document.getElementById('rotateBtn').textContent = hebrewStrings.rotate;
        document.getElementById('helpBtn').textContent = hebrewStrings.howToPlay;
        document.getElementById('newBtn').textContent = hebrewStrings.newGame;
        document.querySelector('[data-label="time"]').textContent = hebrewStrings.time;
        document.querySelector('[data-label="swaps"]').textContent = hebrewStrings.swaps;
        document.getElementById('faceName').textContent = hebrewStrings.faceNames[currentFace];
        document.querySelectorAll('[data-badge="playing"]').forEach(el => el.textContent = hebrewStrings.playing);
        
        document.getElementById('helpTitle').textContent = hebrewStrings.helpTitle;
        document.getElementById('helpGoal').textContent = hebrewStrings.helpGoal;
        document.getElementById('helpHowTo').textContent = hebrewStrings.helpHowTo;
        document.getElementById('helpTipsTitle').textContent = hebrewStrings.helpTipsTitle;
        document.getElementById('helpTip1').textContent = hebrewStrings.helpTip1;
        document.getElementById('helpTip2').textContent = hebrewStrings.helpTip2;
        document.getElementById('helpTip3').textContent = hebrewStrings.helpTip3;
        
        document.getElementById('startBtn').classList.add('wobble-animation');
    }

    function toggleHelp() {
      document.getElementById('helpModal').classList.toggle('show');
    }

    newGame();
  </script>
</body>
</html>